// === SECURITY MODULE ===
const _0x = {
    // Base64 Encoded Content (Multi-File Upload Only) - UPDATED WITH MUSIC CONTROLS
    c: "PGRpdiBjbGFzcz0iYmFja2dyb3VuZC1nbG93Ij48L2Rpdj48ZGl2IGlkPSJsb2dpblNjcmVlbiIgY2xhc3M9ImF1dGgtc2NyZWVuIj48ZGl2IGNsYXNzPSJhdXRoLWJveCI+PGRpdiBjbGFzcz0ibG9nbyI+PGkgY2xhc3M9ImZhLXNvbGlkIGZhLXNoaWVsZC1oYWx2ZWQiPjwvaT48aDE+U2VjdXJlIENvbXBpbGVyPC9oMT48L2Rpdj48aW5wdXQgdHlwZT0idGV4dCIgaWQ9ImxvZ2luVXNlcm5hbWUiIHBsYWNlaG9sZGVyPSJVc2VybmFtZSIgYXV0b2NvbXBsZXRlPSJ1c2VybmFtZSI+PGlucHV0IHR5cGU9InBhc3N3b3JkIiBpZD0ibG9naW5QYXNzd29yZCIgcGxhY2Vob2xkZXI9IlBhc3N3b3JkIiBhdXRvY29tcGxldGU9ImN1cnJlbnQtcGFzc3dvcmQiPjxkaXYgY2xhc3M9InJlbWVtYmVyLW1lLWNvbnRhaW5lciI+PGxhYmVsIGNsYXNzPSJjaGVja2JveC1jb250YWluZXIiPjxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9InJlbWVtYmVyTWUiPjxzcGFuIGNsYXNzPSJjaGVja21hcmsiPjwvc3Bhbj48c3BhbiBjbGFzcz0ibGFiZWwtdGV4dCI+UmVtZW1iZXIgbWU8L3NwYW4+PC9sYWJlbD48L2Rpdj48YnV0dG9uIGlkPSJsb2dpbkJ0biIgY2xhc3M9ImJ0bi1sb2dpbiI+TG9naW48L2J1dHRvbj48ZGl2IGlkPSJsb2dpbkVycm9yIiBjbGFzcz0iZXJyb3ItbWVzc2FnZSBoaWRkZW4iPjwvZGl2PjwvZGl2PjwvZGl2PjxkaXYgaWQ9ImNvbXBpbGVyU2NyZWVuIiBjbGFzcz0iY29udGFpbmVyIGhpZGRlbiI+PGhlYWRlcj48ZGl2IGNsYXNzPSJsb2dvIj48aSBjbGFzcz0iZmEtc29saWQgZmEtY29kZS1icmFuY2giPjwvaT48aDE+RWR5IDxzcGFuIGNsYXNzPSJoaWdobGlnaHQiPkNvbXBpbGVyPC9zcGFuPjwvaDE+PC9kaXY+PGRpdiBjbGFzcz0idXNlci1pbmZvIj48c3BhbiBpZD0idGltZVJlbWFpbmluZyIgY2xhc3M9InRpbWUtcmVtYWluaW5nIj48L3NwYW4+PHNwYW4gaWQ9ImN1cnJlbnRVc2VyIj48L3NwYW4+PGJ1dHRvbiBpZD0ibG9nb3V0QnRuIiBjbGFzcz0iYnRuLXNlY29uZGFyeSI+TG9nb3V0PC9idXR0b24+PC9kaXY+PC9oZWFkZXI+PG1haW4+PGRpdiBjbGFzcz0idXBsb2FkLWNvbnRhaW5lciI+PGRpdiBjbGFzcz0idXBsb2FkLWJveCI+PGkgY2xhc3M9ImZhLXNvbGlkIGZhLWNsb3VkLXVwbG9hZCI+PC9pPjxoMz5TdWJpciBBcmNoaXZvcyBMdWE8L2gzPjxwIGNsYXNzPSJ1cGxvYWQtc3RhdHMiPjxpIGlkPSJmaWxlQ291bnQiPjA8L2k+IGFyY2hpdm8ocykgc2VsZWNjaW9uYWRvKHMpPC9wPjxsYWJlbCBmb3I9ImZpbGVJbnB1dCIgY2xhc3M9InVwbG9hZC1idXR0b24iPjxpIGNsYXNzPSJmYS1zb2xpZCBmYS1mb2xkZXItb3BlbiI+PC9pPiBTZWxlY2Npb25hciBBcmNoaXZvczwvbGFiZWw+PGlucHV0IHR5cGU9ImZpbGUiIGlkPSJmaWxlSW5wdXQiIGFjY2VwdD0iLmx1YSIgbXVsdGlwbGUgaGlkZGVuPjxkaXYgaWQ9ImZpbGVMaXN0IiBjbGFzcz0iZmlsZS1saXN0Ij48L2Rpdj48L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJhY3Rpb24tYXJlYSI+PGJ1dHRvbiBpZD0iY29tcGlsZUJ0biIgY2xhc3M9InByaW1hcnktYnRuIiBkaXNhYmxlZD48c3BhbiBjbGFzcz0iYnRuLWNvbnRlbnQiPjxpIGNsYXNzPSJmYS1zb2xpZCBmYS1sb2NrIj48L2k+IENvbXBpbGFyIFRvZG9zPC9zcGFuPjxkaXYgY2xhc3M9ImxvYWRlciBoaWRkZW4iPjwvZGl2PjwvYnV0dG9uPjwvZGl2PjxkaXYgaWQ9InN0YXR1c01lc3NhZ2UiIGNsYXNzPSJzdGF0dXMtbWVzc2FnZSBoaWRkZW4iPjwvZGl2PjwvbWFpbj48Zm9vdGVyPjxwPkVkeSBDb21waWxlciAmYnVsbDsgQ29weXJpZ2h0czwvcD48L2Zvb3Rlcj48ZGl2IGNsYXNzPSJtdXNpYy1wbGF5ZXIiIGlkPSJtdXNpY1BsYXllciI+PGJ1dHRvbiBpZD0icGxheVBhdXNlQnRuIiBjbGFzcz0ibXVzaWMtYnRuIj48aSBjbGFzcz0iZmEtc29saWQgZmEtcGxheSI+PC9pPjwvYnV0dG9uPjxkaXYgY2xhc3M9Im11c2ljLWljb24iPjxpIGNsYXNzPSJmYS1zb2xpZCBmYS1tdXNpYyI+PC9pPjwvZGl2PjxkaXYgY2xhc3M9InZvbHVtZS1jb250YWluZXIiPjxpbnB1dCB0eXBlPSJyYW5nZSIgaWQ9InZvbHVtZVNsaWRlciIgY2xhc3M9InZvbHVtZS1zbGlkZXIiIG1pbj0iMCIgbWF4PSIxIiBzdGVwPSIwLjAxIiB2YWx1ZT0iMC4wNSI+PC9kaXY+PC9kaXY+PGF1ZGlvIGlkPSJiZ011c2ljIiBzcmM9Im11c2ljLm1wMyIgbG9vcCBhdXRvcGxheT48L2F1ZGlvPjwvZGl2Pg==",

    // Decode and Inject
    d: function () {
        try {
            const d = atob(this.c);
            document.body.innerHTML = d;
            return true;
        } catch (e) {
            document.body.innerHTML = '<h1>Error 0x92</h1>';
            return false;
        }
    },

    // Anti-Debug & Protection
    p: function () {
        // Anti-Save (Ctrl+S)
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                alert('Protected Content');
            }
        });
    }
};

// === AUTHENTICATION SYSTEM ===
const AUTH = {
    init() {
        // Inject Content First
        if (!_0x.d()) return;
        _0x.p();

        this.initDefaultUsers();
        this.checkRememberMe();
        this.setupEventListeners();
        this.setupMusic();

        // Start timer for remaining time
        setInterval(() => this.updateTimeRemaining(), 60000);
    },

    setupMusic() {
        // Poll for the audio element until it exists
        const checkAudio = setInterval(() => {
            const audio = document.getElementById('bgMusic');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const musicPlayer = document.getElementById('musicPlayer');

            if (audio && playPauseBtn && volumeSlider) {
                clearInterval(checkAudio);
                console.log("Audio controls found, initializing...");

                audio.volume = 0.05; // 5% volume (very low)

                const updatePlayIcon = () => {
                    const icon = playPauseBtn.querySelector('i');
                    if (audio.paused) {
                        icon.className = 'fa-solid fa-play';
                        musicPlayer.classList.remove('music-playing');
                    } else {
                        icon.className = 'fa-solid fa-pause';
                        musicPlayer.classList.add('music-playing');
                    }
                };

                // Play/Pause Toggle
                playPauseBtn.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                    }
                    updatePlayIcon();
                });

                // Volume Control
                volumeSlider.addEventListener('input', (e) => {
                    audio.volume = e.target.value;
                });

                // Auto-play logic
                const playAudio = () => {
                    audio.play().then(() => {
                        console.log("Audio playing successfully");
                        updatePlayIcon();
                    }).catch(error => {
                        console.log("Autoplay prevented, waiting for interaction");
                        updatePlayIcon(); // Show play button

                        // Add one-time listeners for interaction
                        const playOnInteraction = () => {
                            audio.play().then(updatePlayIcon);
                            document.removeEventListener('click', playOnInteraction);
                            document.removeEventListener('keydown', playOnInteraction);
                        };
                        document.addEventListener('click', playOnInteraction);
                        document.addEventListener('keydown', playOnInteraction);
                    });
                };

                playAudio();
            }
        }, 500); // Check every 500ms
    },

    // AQUI PUEDES AGREGAR USUARIOS FIJOS PARA QUE FUNCIONEN EN CUALQUIER PC
    initDefaultUsers() {
        const users = this.getUsers();

        // HERRAMIENTA PARA PONER DIAS FACIL:
        const days = (n) => new Date().getTime() + (n * 24 * 60 * 60 * 1000);

        // Lista de usuarios fijos
        const fixedUsers = {
            'Edyhinz': {
                password: 'Edyhinz1245',
                role: 'admin',
                expiry: null // null = Nunca expira
            },
            // Agrega aquÃ­ el usuario de tu amigo:
            'DEF9NETE': {
                password: 'DEF999NETE',
                role: 'user',
                expiry: null // null = infinito, o usa days(30)
            }
        };

        let hasChanges = false;
        for (const [username, data] of Object.entries(fixedUsers)) {
            if (!users[username]) {
                users[username] = data;
                hasChanges = true;
            }
        }

        if (hasChanges) {
            this.saveUsers(users);
        }
    },

    checkRememberMe() {
        const savedUser = localStorage.getItem('compiler_remembered_user');
        if (savedUser) {
            const users = this.getUsers();
            if (users[savedUser]) {
                this.login(savedUser, users[savedUser].password, true);
                this.showCompilerScreen();
            }
        } else {
            this.showLoginScreen();
        }
    },

    getUsers() {
        return JSON.parse(localStorage.getItem('compiler_users') || '{}');
    },

    saveUsers(users) {
        localStorage.setItem('compiler_users', JSON.stringify(users));
    },

    getCurrentUser() {
        return localStorage.getItem('compiler_current_user');
    },

    login(username, password, remember = false) {
        const users = this.getUsers();
        const user = users[username];

        if (!user) {
            return { success: false, message: 'User not found' };
        }

        if (user.password !== password) {
            return { success: false, message: 'Incorrect password' };
        }

        if (user.expiry && new Date().getTime() > user.expiry) {
            delete users[username];
            this.saveUsers(users);
            return { success: false, message: 'Account has expired' };
        }

        localStorage.setItem('compiler_current_user', username);
        localStorage.setItem('compiler_user_role', user.role);

        if (remember) {
            localStorage.setItem('compiler_remembered_user', username);
        } else {
            localStorage.removeItem('compiler_remembered_user');
        }

        return { success: true };
    },

    logout() {
        localStorage.removeItem('compiler_current_user');
        localStorage.removeItem('compiler_user_role');
        localStorage.removeItem('compiler_remembered_user');
        this.showLoginScreen();
    },

    updateTimeRemaining() {
        const username = this.getCurrentUser();
        if (!username) return;

        const users = this.getUsers();
        const user = users[username];
        const timeEl = document.getElementById('timeRemaining');

        if (user && user.expiry) {
            const remaining = user.expiry - new Date().getTime();
            if (remaining > 0) {
                const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
                const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                timeEl.textContent = `â³ ${days}d ${hours}h ${minutes}m`;
                timeEl.classList.remove('hidden');
            } else {
                this.logout(); // Auto logout if expired
            }
        } else {
            timeEl.textContent = 'â™¾ï¸ Unlimited';
            timeEl.classList.remove('hidden');
        }
    },

    showLoginScreen() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('compilerScreen').classList.add('hidden');
    },

    showCompilerScreen() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('compilerScreen').classList.remove('hidden');

        const username = this.getCurrentUser();
        document.getElementById('currentUser').textContent = `ðŸ‘¤ ${username}`;
        this.updateTimeRemaining();
    },

    setupEventListeners() {
        // Login
        document.getElementById('loginBtn').addEventListener('click', () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            const result = this.login(username, password, remember);

            if (result.success) {
                this.showCompilerScreen();
            } else {
                const errorEl = document.getElementById('loginError');
                errorEl.textContent = result.message;
                errorEl.classList.remove('hidden');
            }
        });

        // Login on Enter key
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            this.logout();
        });
    }
};

// === COMPILER CODE ===
document.addEventListener('DOMContentLoaded', () => {
    // Block context menu and copy shortcuts
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('keydown', event => {
        if (event.ctrlKey && (event.key === 'c' || event.key === 'u' || event.key === 's' || event.key === 'p' || event.key === 'a')) {
            event.preventDefault();
        }
    });

    // Initialize authentication (which now injects content)
    AUTH.init();

    // Multi-file compiler code
    const compileBtn = document.getElementById('compileBtn');
    const fileInput = document.getElementById('fileInput');
    const statusMessage = document.getElementById('statusMessage');
    const fileCount = document.getElementById('fileCount');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];

    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);

            // Filter out duplicates if needed, or just append
            // Here we just append all new files
            selectedFiles = [...selectedFiles, ...newFiles];

            updateFileList();
            compileBtn.disabled = selectedFiles.length === 0;

            // Reset input so you can select the same file again if you want
            fileInput.value = '';
        });
    }

    const updateFileList = () => {
        if (!fileCount || !fileList) return;

        fileCount.textContent = selectedFiles.length;

        if (selectedFiles.length === 0) {
            fileList.innerHTML = '<p class="no-files">No hay archivos seleccionados</p>';
            return;
        }

        fileList.innerHTML = selectedFiles.map((file, index) => `
            <div class="file-item">
                <i class="fa-brands fa-lua"></i>
                <span class="file-name">${file.name}</span>
                <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
                <button class="remove-file-btn" data-index="${index}" title="Eliminar">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        `).join('');

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-file-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.getAttribute('data-index'));
                selectedFiles.splice(index, 1);
                updateFileList();
                compileBtn.disabled = selectedFiles.length === 0;
            });
        });
    };

    // Initialize file list
    updateFileList();

    const showStatus = (msg, type) => {
        if (!statusMessage) return;
        statusMessage.textContent = msg;
        statusMessage.className = `status-message ${type}`;
        statusMessage.classList.remove('hidden');
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    };

    const generateRandomString = (length) => {
        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    };

    const compileLocally = (sourceCode) => {
        const encodeString = (str) => {
            const bytes = [];
            for (let i = 0; i < str.length; i++) {
                bytes.push(str.charCodeAt(i));
            }
            return `string.char(${bytes.join(',')})`;
        };

        let obfuscatedCode = sourceCode.replace(/"([^"]*)"|'([^']*)'/g, (match, dq, sq) => {
            const str = dq || sq;
            if (str && str.length > 0) {
                return encodeString(str);
            }
            return match;
        });

        const varPattern = /local\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;
        const funcPattern = /function\s+([a-zA-Z_][a-zA-Z0-9_]*)/g;

        let matches;
        const identifiers = new Set();

        while ((matches = varPattern.exec(obfuscatedCode)) !== null) {
            identifiers.add(matches[1]);
        }

        while ((matches = funcPattern.exec(obfuscatedCode)) !== null) {
            identifiers.add(matches[1]);
        }

        const replacements = {};
        const reserved = ['true', 'false', 'nil', 'and', 'or', 'not', 'if', 'then', 'else',
            'elseif', 'end', 'for', 'while', 'do', 'repeat', 'until', 'function',
            'local', 'return', 'break', 'in', 'pairs', 'ipairs', 'print', 'client',
            'source', 'root', 'resourceRoot', 'math', 'string', 'table'];

        identifiers.forEach(name => {
            if (!reserved.includes(name)) {
                replacements[name] = '_' + generateRandomString(Math.floor(Math.random() * 4) + 3);
            }
        });

        for (const [oldName, newName] of Object.entries(replacements)) {
            const regex = new RegExp('(?<![.])\\b' + oldName + '\\b(?![.])', 'g');
            obfuscatedCode = obfuscatedCode.replace(regex, newName);
        }

        const dummyCount = Math.floor(Math.random() * 5) + 3;
        let dummies = '';
        for (let i = 0; i < dummyCount; i++) {
            const dummyName = '_' + generateRandomString(4);
            const dummyValue = Math.floor(Math.random() * 1000);
            dummies += `${dummyName}=${dummyValue};`;
        }

        obfuscatedCode = dummies + obfuscatedCode;
        obfuscatedCode = obfuscatedCode.replace(/\blocal\s+/g, '');

        obfuscatedCode = obfuscatedCode
            .replace(/--\[\[[\s\S]*?\]\]/g, '')
            .replace(/--[^\n]*/g, '')
            .replace(/\s+/g, ' ')
            .replace(/\s*([=+\-*/<>~,;:(){}[\]])\s*/g, '$1')
            .trim();

        const totalLines = 200;
        const codePosition = Math.floor(Math.random() * 40) + 80;

        let binaryHeader = "--[[";

        for (let line = 0; line < totalLines; line++) {
            const lineLength = Math.floor(Math.random() * 60) + 30;
            let lineContent = "";
            for (let i = 0; i < lineLength; i++) {
                let c;
                do {
                    c = Math.floor(Math.random() * (126 - 33 + 1)) + 33;
                } while (c === 91 || c === 93);
                lineContent += String.fromCharCode(c);
            }
            binaryHeader += lineContent + "\n";

            if (line === codePosition) {
                binaryHeader += "]] " + obfuscatedCode + " --[[\n";
            }
        }

        binaryHeader += "]]";

        return binaryHeader;
    };

    if (compileBtn) {
        compileBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                showStatus('Por favor selecciona al menos un archivo.', 'error');
                return;
            }

            compileBtn.classList.add('loading');
            compileBtn.disabled = true;
            statusMessage.classList.add('hidden');

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];

                try {
                    const fileContent = await readFileAsText(file);
                    const compiledCode = compileLocally(fileContent);

                    const blob = new Blob([compiledCode], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    let downloadName = file.name;
                    if (downloadName.endsWith('.lua')) {
                        downloadName = downloadName.substring(0, downloadName.length - 4);
                    }
                    if (!downloadName.endsWith('.luac')) {
                        downloadName += '.luac';
                    }

                    a.download = downloadName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    successCount++;

                    // Small delay between downloads to avoid browser blocking
                    if (i < selectedFiles.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                } catch (error) {
                    console.error(`Error compiling ${file.name}:`, error);
                    failCount++;
                }
            }

            compileBtn.classList.remove('loading');
            compileBtn.disabled = false;

            if (failCount === 0) {
                showStatus(`âœ“ ${successCount} archivo(s) compilado(s) exitosamente!`, 'success');
            } else if (successCount === 0) {
                showStatus(`âœ— Error: No se pudo compilar ningÃºn archivo.`, 'error');
            } else {
                showStatus(`âš  ${successCount} archivo(s) compilado(s), ${failCount} fallaron.`, 'error');
            }
        });
    }

    // Helper function to read file as text
    const readFileAsText = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    };
});
